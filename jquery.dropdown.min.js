!function(p){"use strict";function e(){}var n=function(){var e=navigator.userAgent.toLowerCase();if(-1!==e.indexOf("safari"))return!(-1<e.indexOf("chrome"))}(),i={readonly:!1,minCount:0,limitCount:1/0,input:'<input type="text" maxLength="20" placeholder="搜索关键词或ID">',data:[],searchable:!0,searchNoData:'<li style="color:#ddd">查无数据，换个词儿试试 /(ㄒoㄒ)/~~</li>',init:e,choice:e,extendProps:[]},l={up:38,down:40,enter:13},d="click.iui-dropdown",a="focus.iui-dropdown",s="keydown.iui-dropdown",r="keyup.iui-dropdown";function c(){var e=this,t=e.config,o=e.$el,n=o.find(".dropdown-minItem-alert");clearTimeout(e.itemCountAlertTimer),0===n.length&&(n=p('<div class="dropdown-minItem-alert">最低选择'+t.minCount+"个</div>")),o.append(n),e.itemCountAlertTimer=setTimeout(function(){o.find(".dropdown-minItem-alert").remove()},1e3)}function u(e){var t=e||"";return t=(t=(t=(t=t.replace(/<select[^>]*>/gi,"").replace("</select>","")).replace(/<\/optgroup>/gi,"")).replace(/<optgroup[^>]*>/gi,function(e){var t=/label="(.[^"]*)"(\s|>)/.exec(e),o=/data\-group\-id="(.[^"]*)"(\s|>)/.exec(e);return'<li class="dropdown-group" data-group-id="'+(o?o[1]:"")+'">'+(t?t[1]:"")+"</li>"})).replace(/<option(.*?)<\/option>/gi,function(e){var t=/value="?([\w\u4E00-\u9FA5\uF900-\uFA2D]+)"?/.exec(e),o=/>(.*)<\//.exec(e),n=-1<e.indexOf("selected"),i=-1<e.indexOf("disabled"),a="";e.replace(/data-(\w+)="?(.[^"]+)"?/g,function(e){a+=e+" "});return"<li "+(i?" disabled":' tabindex="0"')+' data-value="'+(t?t[1]:"")+'" class="dropdown-option '+(n?"dropdown-chose":"")+'" '+a+">"+(o?o[1]:"")+"</li>"})}function h(e){var d={},a="",s=[],r=0,c=this.config.extendProps;return!(!e||!e.length)&&(p.each(e,function(e,o){var t=o.groupId,n=o.disabled?" disabled":"",i=o.selected&&!n?" selected":"",a="";p.each(c,function(e,t){o[t]&&(a+="data-"+t+'="'+o[t]+'" ')});var l="<option"+n+i+' value="'+o.id+'" '+a+">"+o.name+"</option>";i&&(s.push('<span class="dropdown-selected">'+o.name+'<i class="del" data-id="'+o.id+'"></i></span>'),r++),t?d[o.groupId]?d[o.groupId]+=l:d[o.groupId]=o.groupName+"&janking&"+l:d[e]=l}),p.each(d,function(e,t){var o=t.split("&janking&");if(2===o.length){var n=o[0],i=o[1];a+='<optgroup label="'+n+'" data-group-id="'+e+'">'+i+"</optgroup>"}else a+=t}),[a,s,r])}var f={show:function(e){e.stopPropagation();p(document).trigger("click.dropdown"),this.$el.addClass("active")},search:function(o,n,i){var a,l,d,s=null,r=0;i||(i={});var c=function(){r=!1===i.leading?0:(new Date).getTime(),s=null,d=o.apply(a,l),s||(a=l=null)};return function(){var e=(new Date).getTime();r||!1!==i.leading||(r=e);var t=n-(e-r);return a=this,l=arguments,t<=0||n<t?(clearTimeout(s),s=null,r=e,d=o.apply(a,l),s||(a=l=null)):s||!1===i.trailing||(s=setTimeout(c,t)),d}}(function(e){var t=this.config,o=this.$el,n=p(e.target).val(),i=this.config.data,a=[];36<e.keyCode&&e.keyCode<41||(p.each(i,function(e,t){(t.groupName&&-1<t.groupName.toLowerCase().indexOf(n.toLowerCase())||-1<t.name.toLowerCase().indexOf(n.toLowerCase())||""+t.id==""+n)&&a.push(t)}),o.find("ul").html(u(h.call(this,a)[0])||t.searchNoData))},300),control:function(e){var t,o,n,i=e.keyCode,a=0;i!==l.down&&i!==l.up||(t=i===l.up?-1:1,a=-1===(o=(n=this.$el.find("[tabindex]")).index(p(document.activeElement)))?t+1?-1:0:o,(a+=t)===n.length&&(a=0),n.eq(a).focus(),e.preventDefault())},multiChoose:function(e,t){var o,n=this,i=n.config,a=n.$select,l=p(e.target),d=l.attr("data-value"),s=l.hasClass("dropdown-chose"),r=[];if(l.hasClass("dropdown-display"))return!1;if(s)l.removeClass("dropdown-chose"),n.selectAmount--;else{if(!(n.selectAmount<i.limitCount))return function(){var e=this,t=e.config,o=e.$el,n=o.find(".dropdown-maxItem-alert");clearTimeout(e.itemLimitAlertTimer),0===n.length&&(n=p('<div class="dropdown-maxItem-alert">最多可选择'+t.limitCount+"个</div>")),o.append(n),e.itemLimitAlertTimer=setTimeout(function(){o.find(".dropdown-maxItem-alert").remove()},1e3)}.call(n),!1;l.addClass("dropdown-chose"),n.selectAmount++}n.name=[],p.each(i.data,function(e,t){""+t.id==""+d&&((o=t).selected=!s),t.selected&&(r.push(t.name),n.name.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>'))}),a.find('option[value="'+d+'"]').prop("selected",!s),s&&n.selectAmount<i.minCount&&c.call(n),n.$choseList.find(".dropdown-selected").remove(),n.$choseList.prepend(n.name.join("")),n.$el.find(".dropdown-display").attr("title",r.join(",")),i.choice.call(n,e,o)},singleChoose:function(e){var o=this,t=o.config,n=o.$el,i=o.$select,a=p(e.target),l=a.attr("data-value"),d=a.hasClass("dropdown-chose");if(a.hasClass("dropdown-chose")||a.hasClass("dropdown-display"))return!1;o.name=[],n.removeClass("active").find("li").not(a).removeClass("dropdown-chose"),a.toggleClass("dropdown-chose"),p.each(t.data,function(e,t){t.selected=!1,""+t.id==""+l&&(t.selected=d?0:1,t.selected&&o.name.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>'))}),i.find('option[value="'+l+'"]').prop("selected",!0),o.name.push('<span class="placeholder">'+o.placeholder+"</span>"),o.$choseList.html(o.name.join("")),t.choice.call(o,e)},del:function(e){var o=this,t=p(e.target),n=t.data("id");return p.each(o.name,function(e,t){if(-1!==t.indexOf('data-id="'+n+'"'))return o.name.splice(e,1),!1}),p.each(o.config.data,function(e,t){if(""+t.id==""+n)return t.selected=!1}),o.selectAmount--,o.$el.find('[data-value="'+n+'"]').removeClass("dropdown-chose"),o.$el.find('[value="'+n+'"]').prop("selected",!1).removeAttr("selected"),t.closest(".dropdown-selected").remove(),!1},clearAll:function(e){var t=this.config;return e&&e.preventDefault(),console.log(this),this.$choseList.find(".del").each(function(e,t){p(t).trigger("click")}),0<t.minCount&&c.call(this),this.$el.find(".dropdown-display").removeAttr("title"),!1}};function m(e,t){this.$el=p(t),this.$select=this.$el.find("select"),this.placeholder=this.$select.attr("placeholder"),this.config=e,this.name=[],this.isSingleSelect=!this.$select.prop("multiple"),this.selectAmount=0,this.itemLimitAlertTimer=null,this.isLabelMode="label"===this.config.multipleMode,this.init()}m.prototype={init:function(){var e=this,t=e.config,o=e.$el;e.$select.hide(),o.addClass(e.isSingleSelect?"dropdown-single":e.isLabelMode?"dropdown-multiple-label":"dropdown-multiple"),0===t.data.length&&(t.data=function(e){var t=e,a=[];function l(e,t){var o=p(t);this.id=o.prop("value"),this.name=o.text(),this.disabled=o.prop("disabled"),this.selected=o.prop("selected")}return p.each(t.children(),function(e,t){var o={},n={},i=p(t);"OPTGROUP"===t.nodeName?(n.groupId=i.data("groupId"),n.groupName=i.attr("label"),p.each(i.children(),p.proxy(l,o)),p.extend(o,n)):p.each(i,p.proxy(l,o)),a.push(o)}),a}(e.$select));var n=h.call(e,t.data);e.name=n[1],e.selectAmount=n[2],e.$select.html(n[0]),e.renderSelect(),e.changeStatus(t.disabled?"disabled":!!t.readonly&&"readonly"),e.config.init()},renderSelect:function(e,t){var o,n=this,i=n.$el,a=u(n.$select.prop("outerHTML"));e?i.find("ul")[t?"html":"append"](a):(o=function(){var e=this.isLabelMode,t=this.config.searchable?'<span class="dropdown-search">'+this.config.input+"</span>":"";return e?'<div class="dropdown-display-label"><div class="dropdown-chose-list">'+t+'</div></div><div class="dropdown-main">{{ul}}</div>':'<a href="javascript:;" class="dropdown-display"><span class="dropdown-chose-list"></span><a href="javascript:;"  class="dropdown-clear-all">×</a></a><div class="dropdown-main">'+t+"{{ul}}</div>"}.call(n).replace("{{ul}}","<ul>"+a+"</ul>"),i.append(o).find("ul").removeAttr("style class")),t&&(n.name=[],n.$el.find(".dropdown-selected").remove(),n.$select.val("")),n.$choseList=i.find(".dropdown-chose-list"),n.isLabelMode||n.$choseList.html(p('<span class="placeholder"></span>').text(n.placeholder)),n.$choseList.prepend(n.name?n.name.join(""):[])},bindEvent:function(){var t=this,o=t.$el,e=n?d:a;o.on(d,function(e){e.stopPropagation()}),o.on(d,".del",p.proxy(f.del,t)),t.isLabelMode?(o.on(d,".dropdown-display-label",function(){o.find("input").focus()}),t.config.searchable?o.on(a,"input",p.proxy(f.show,t)):o.on(d,p.proxy(f.show,t)),o.on(s,"input",function(e){8===e.keyCode&&""===this.value&&t.name.length&&o.find(".del").eq(-1).trigger("click")})):(o.on(e,".dropdown-display",p.proxy(f.show,t)),o.on(e,".dropdown-clear-all",p.proxy(f.clearAll,t))),o.on(r,"input",p.proxy(f.search,t)),o.on(r,function(e){e.keyCode===l.enter&&p.proxy(t.isSingleSelect?f.singleChoose:f.multiChoose,t,e)()}),o.on(s,p.proxy(f.control,t)),o.on(d,"[tabindex]",p.proxy(t.isSingleSelect?f.singleChoose:f.multiChoose,t))},unbindEvent:function(){var e=this.$el,t=n?d:a;e.off(d),e.off(d,".del"),this.isLabelMode?(e.off(d,".dropdown-display-label"),e.off(a,"input"),e.off(s,"input")):(e.off(t,".dropdown-display"),e.off(t,".dropdown-clear-all")),e.off(r,"input"),e.off(r),e.off(s),e.off(d,"[tabindex]")},changeStatus:function(e){var t=this;"readonly"===e?t.unbindEvent():"disabled"===e?(t.$select.prop("disabled",!0),t.unbindEvent()):(t.$select.prop("disabled",!1),t.bindEvent())},update:function(e,t){var o=this,n=o.config,i=(o.$el,t||!1);if("[object Array]"===Object.prototype.toString.call(e)){n.data=i?e.slice(0):n.data.concat(e);var a=h.call(o,n.data);o.name=a[1],o.selectAmount=a[2],o.$select.html(a[0]),o.renderSelect(!0,i)}},destroy:function(){this.unbindEvent(),this.$el.children().not("select").remove(),this.$el.removeClass("dropdown-single dropdown-multiple-label dropdown-multiple"),this.$select.show()},choose:function(e,n){var t="[object Array]"===Object.prototype.toString.call(e)?e:[e],i=this,a=void 0===n||!!n;p.each(t,function(e,t){var o=i.$el.find('[data-value="'+t+'"]');o.hasClass("dropdown-chose")!==a&&o.trigger(d,n||!0)})},reset:function(){f.clearAll.call(this)}},p(document).on("click.dropdown",function(){p(".dropdown-single,.dropdown-multiple,.dropdown-multiple-label").removeClass("active")}),p.fn.dropdown=function(o){return this.each(function(e,t){p(t).data("dropdown",new m(p.extend(!0,{},i,o),t))}),this}}(jQuery);

