!function(e){"use strict";function t(){}var o=function(){var e=navigator.userAgent.toLowerCase();if(-1!==e.indexOf("safari"))return!(e.indexOf("chrome")>-1)}(),n={readonly:!1,minCount:0,minCountErrorMessage:"",limitCount:1/0,limitCountErrorMessage:"",input:'<input type="text" maxLength="20" placeholder="搜索关键词或ID">',data:[],searchable:!0,searchNoData:'<li style="color:#ddd">查无数据，换个词儿试试 /(ㄒoㄒ)/~~</li>',init:t,choice:t,extendProps:[]},i={up:38,down:40,enter:13},a="click.iui-dropdown",l="focus.iui-dropdown",d="keydown.iui-dropdown",s="keyup.iui-dropdown",r=1e3;function c(){var t=this,o=t.config,n=t.$el,i=n.find(".dropdown-minItem-alert"),a=o.minCountErrorMessage;clearTimeout(t.itemCountAlertTimer),0===i.length&&(a||(a="最低选择"+o.minCount+"个"),i=e('<div class="dropdown-minItem-alert">'+a+"</div>")),n.append(i),t.itemCountAlertTimer=setTimeout(function(){n.find(".dropdown-minItem-alert").remove()},r)}function p(t){var o=t||"";return o=(o=(o=(o=o.replace(/<select[^>]*>/gi,"").replace("</select>","")).replace(/<\/optgroup>/gi,"")).replace(/<optgroup[^>]*>/gi,function(e){var t=/label="(.[^"]*)"(\s|>)/.exec(e),o=/data\-group\-id="(.[^"]*)"(\s|>)/.exec(e);return'<li class="dropdown-group" data-group-id="'+(o?o[1]:"")+'">'+(t?t[1]:"")+"</li>"})).replace(/<option(.*?)<\/option>/gi,function(t){var o=e(t).val(),n=/>(.*)<\//.exec(t),i=t.indexOf("selected")>-1,a=t.indexOf("disabled")>-1,l="";t.replace(/data-(\w+)="?(.[^"]+)"?/g,function(e){l+=e+" "});return"<li "+(a?" disabled":' tabindex="0"')+' data-value="'+(o||"")+'" class="dropdown-option '+(i?"dropdown-chose":"")+'" '+l+">"+(n?n[1]:"")+"</li>"})}function u(t){var o={},n="",i=[],a=0,l=this.config.extendProps;return!(!t||!t.length)&&(e.each(t,function(t,n){var d=n.groupId,s=n.disabled?" disabled":"",r=n.selected&&!s?" selected":"",c="";e.each(l,function(e,t){n[t]&&(c+="data-"+t+'="'+n[t]+'" ')});var p="<option"+s+r+' value="'+n.id+'" '+c+">"+n.name+"</option>";r&&(i.push('<span class="dropdown-selected">'+n.name+'<i class="del" data-id="'+n.id+'"></i></span>'),a++),d?o[n.groupId]?o[n.groupId]+=p:o[n.groupId]=n.groupName+"&janking&"+p:o[t]=p}),e.each(o,function(e,t){var o=t.split("&janking&");if(2===o.length){var i=o[0],a=o[1];n+='<optgroup label="'+i+'" data-group-id="'+e+'">'+a+"</optgroup>"}else n+=t}),[n,i,a])}var h={show:function(t){t.stopPropagation();e(document).trigger("click.dropdown"),this.$el.addClass("active")},search:function(e,t,o){var n,i,a,l=null,d=0;o||(o={});var s=function(){d=!1===o.leading?0:(new Date).getTime(),l=null,a=e.apply(n,i),l||(n=i=null)};return function(){var r=(new Date).getTime();d||!1!==o.leading||(d=r);var c=t-(r-d);return n=this,i=arguments,c<=0||c>t?(clearTimeout(l),l=null,d=r,a=e.apply(n,i),l||(n=i=null)):l||!1===o.trailing||(l=setTimeout(s,c)),a}}(function(t){var o=this.config,n=this.$el,i=e(t.target).val(),a=this.config.data,l=[];t.keyCode>36&&t.keyCode<41||(e.each(a,function(e,t){(t.groupName&&t.groupName.toLowerCase().indexOf(i.toLowerCase())>-1||t.name.toLowerCase().indexOf(i.toLowerCase())>-1||""+t.id==""+i)&&l.push(t)}),n.find("ul").html(p(u.call(this,l)[0])||o.searchNoData))},300),control:function(t){var o,n,a,l=t.keyCode,d=0;l!==i.down&&l!==i.up||(o=l===i.up?-1:1,d=-1===(n=(a=this.$el.find("[tabindex]")).index(e(document.activeElement)))?o+1?-1:0:n,(d+=o)===a.length&&(d=0),a.eq(d).focus(),t.preventDefault())},multiChoose:function(t,o){var n,i=this,a=i.config,l=i.$select,d=e(t.target),s=d.attr("data-value"),p=d.hasClass("dropdown-chose"),u=[];if(d.hasClass("dropdown-display"))return!1;if(p)d.removeClass("dropdown-chose"),i.selectAmount--;else{if(!(i.selectAmount<a.limitCount))return function(){var t=this,o=t.config,n=t.$el,i=n.find(".dropdown-maxItem-alert"),a=o.limitCountErrorMessage;clearTimeout(t.itemLimitAlertTimer),0===i.length&&(a||(a="最多可选择"+o.limitCount+"个"),i=e('<div class="dropdown-maxItem-alert">'+a+"</div>")),n.append(i),t.itemLimitAlertTimer=setTimeout(function(){n.find(".dropdown-maxItem-alert").remove()},r)}.call(i),!1;d.addClass("dropdown-chose"),i.selectAmount++}i.name=[],e.each(a.data,function(e,t){""+t.id==""+s&&(n=t,t.selected=!p),t.selected&&(u.push(t.name),i.name.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>'))}),l.find('option[value="'+s+'"]').prop("selected",!p),p&&i.selectAmount<a.minCount&&c.call(i),i.$choseList.find(".dropdown-selected").remove(),i.$choseList.prepend(i.name.join("")),i.$el.find(".dropdown-display").attr("title",u.join(",")),a.choice.call(i,t,n)},singleChoose:function(t){var o=this,n=o.config,i=o.$el,a=o.$select,l=e(t.target),d=l.attr("data-value"),s=l.hasClass("dropdown-chose");if(l.hasClass("dropdown-chose")||l.hasClass("dropdown-display"))return!1;o.name=[],i.removeClass("active").find("li").not(l).removeClass("dropdown-chose"),l.toggleClass("dropdown-chose"),e.each(n.data,function(e,t){t.selected=!1,""+t.id==""+d&&(t.selected=s?0:1,t.selected&&o.name.push('<span class="dropdown-selected">'+t.name+'<i class="del" data-id="'+t.id+'"></i></span>'))}),a.find('option[value="'+d+'"]').prop("selected",!0),o.name.push('<span class="placeholder">'+o.placeholder+"</span>"),o.$choseList.html(o.name.join("")),n.choice.call(o,t)},del:function(t){var o=this,n=e(t.target),i=n.data("id");return e.each(o.name,function(e,t){if(-1!==t.indexOf('data-id="'+i+'"'))return o.name.splice(e,1),!1}),e.each(o.config.data,function(e,t){if(""+t.id==""+i)return t.selected=!1,!1}),o.selectAmount--,o.$el.find('[data-value="'+i+'"]').removeClass("dropdown-chose"),o.$el.find('[value="'+i+'"]').prop("selected",!1).removeAttr("selected"),n.closest(".dropdown-selected").remove(),!1},clearAll:function(t){var o=this.config;return t&&t.preventDefault(),console.log(this),this.$choseList.find(".del").each(function(t,o){e(o).trigger("click")}),o.minCount>0&&c.call(this),this.$el.find(".dropdown-display").removeAttr("title"),!1}};function f(t,o){this.$el=e(o),this.$select=this.$el.find("select"),this.placeholder=this.$select.attr("placeholder"),this.config=t,this.name=[],this.isSingleSelect=!this.$select.prop("multiple"),this.selectAmount=0,this.itemLimitAlertTimer=null,this.isLabelMode="label"===this.config.multipleMode,this.init()}f.prototype={init:function(){var t=this,o=t.config,n=t.$el;t.$select.hide(),n.addClass(t.isSingleSelect?"dropdown-single":t.isLabelMode?"dropdown-multiple-label":"dropdown-multiple"),0===o.data.length&&(o.data=function(t){var o=t,n=[];function i(t,o){var n=e(o);this.id=n.prop("value"),this.name=n.text(),this.disabled=n.prop("disabled"),this.selected=n.prop("selected")}return e.each(o.children(),function(t,o){var a={},l={},d=e(o);"OPTGROUP"===o.nodeName?(l.groupId=d.data("groupId"),l.groupName=d.attr("label"),e.each(d.children(),e.proxy(i,a)),e.extend(a,l)):e.each(d,e.proxy(i,a)),n.push(a)}),n}(t.$select));var i=u.call(t,o.data);t.name=i[1],t.selectAmount=i[2],t.$select.html(i[0]),t.renderSelect(),t.changeStatus(o.disabled?"disabled":!!o.readonly&&"readonly"),t.config.init()},renderSelect:function(t,o){var n,i=this,a=i.$el,l=p(i.$select.prop("outerHTML"));t?a.find("ul")[o?"html":"append"](l):(n=function(){var e=this.isLabelMode,t=this.config.searchable?'<span class="dropdown-search">'+this.config.input+"</span>":"";return e?'<div class="dropdown-display-label"><div class="dropdown-chose-list">'+t+'</div></div><div class="dropdown-main">{{ul}}</div>':'<a href="javascript:;" class="dropdown-display" tabindex="0"><span class="dropdown-chose-list"></span><a href="javascript:;"  class="dropdown-clear-all" tabindex="0">×</a></a><div class="dropdown-main">'+t+"{{ul}}</div>"}.call(i).replace("{{ul}}","<ul>"+l+"</ul>"),a.append(n).find("ul").removeAttr("style class")),o&&(i.name=[],i.$el.find(".dropdown-selected").remove(),i.$select.val("")),i.$choseList=a.find(".dropdown-chose-list"),i.isLabelMode||i.$choseList.html(e('<span class="placeholder"></span>').text(i.placeholder)),i.$choseList.prepend(i.name?i.name.join(""):[])},bindEvent:function(){var t=this,n=t.$el,r=o?a:l;n.on(a,function(e){e.stopPropagation()}),n.on(a,".del",e.proxy(h.del,t)),t.isLabelMode?(n.on(a,".dropdown-display-label",function(){n.find("input").focus()}),t.config.searchable?n.on(l,"input",e.proxy(h.show,t)):n.on(a,e.proxy(h.show,t)),n.on(d,"input",function(e){8===e.keyCode&&""===this.value&&t.name.length&&n.find(".del").eq(-1).trigger("click")})):(n.on(r,".dropdown-display",e.proxy(h.show,t)),n.on(r,".dropdown-clear-all",e.proxy(h.clearAll,t))),n.on(s,"input",e.proxy(h.search,t)),n.on(s,function(o){o.keyCode===i.enter&&e.proxy(t.isSingleSelect?h.singleChoose:h.multiChoose,t,o)()}),n.on(d,e.proxy(h.control,t)),n.on(a,"li[tabindex]",e.proxy(t.isSingleSelect?h.singleChoose:h.multiChoose,t))},unbindEvent:function(){var e=this.$el,t=o?a:l;e.off(a),e.off(a,".del"),this.isLabelMode?(e.off(a,".dropdown-display-label"),e.off(l,"input"),e.off(d,"input")):(e.off(t,".dropdown-display"),e.off(t,".dropdown-clear-all")),e.off(s,"input"),e.off(s),e.off(d),e.off(a,"[tabindex]")},changeStatus:function(e){var t=this;"readonly"===e?t.unbindEvent():"disabled"===e?(t.$select.prop("disabled",!0),t.unbindEvent()):(t.$select.prop("disabled",!1),t.bindEvent())},update:function(e,t){var o=this,n=o.config,i=(o.$el,t||!1);if("[object Array]"===Object.prototype.toString.call(e)){n.data=i?e.slice(0):n.data.concat(e);var a=u.call(o,n.data);o.name=a[1],o.selectAmount=a[2],o.$select.html(a[0]),o.renderSelect(!0,i)}},destroy:function(){this.unbindEvent(),this.$el.children().not("select").remove(),this.$el.removeClass("dropdown-single dropdown-multiple-label dropdown-multiple"),this.$select.show()},choose:function(t,o){var n="[object Array]"===Object.prototype.toString.call(t)?t:[t],i=this,l=void 0===o||!!o;e.each(n,function(e,t){var n=i.$el.find('[data-value="'+t+'"]');n.hasClass("dropdown-chose")!==l&&n.trigger(a,o||!0)})},reset:function(){h.clearAll.call(this)}},e(document).on("click.dropdown",function(){e(".dropdown-single,.dropdown-multiple,.dropdown-multiple-label").removeClass("active")}),e.fn.dropdown=function(t){return this.each(function(o,i){e(i).data("dropdown",new f(e.extend(!0,{},n,t),i))}),this}}(jQuery);
